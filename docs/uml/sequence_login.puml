@startuml Login Sequence
!theme plain

title My Nottingham - User Login Sequence Diagram

actor User
participant "LoginFragment" as LF
participant "LoginViewModel" as LVM
participant "FirebaseUserRepository" as Repo
participant "FirebaseAuth" as Auth
participant "FirebaseDatabase" as DB
participant "TokenManager" as TM

User -> LF: Enter email & password
LF -> LF: Validate input format
LF -> LVM: login(email, password)
activate LVM

LVM -> Repo: login(email, password)
activate Repo

Repo -> Auth: signInWithEmailAndPassword()
activate Auth
Auth --> Repo: AuthResult (uid)
deactivate Auth

Repo -> DB: getReference("users/{uid}")
activate DB
DB --> Repo: User data snapshot
deactivate DB

Repo -> Repo: Parse user data
Repo --> LVM: Result<User>
deactivate Repo

LVM -> TM: saveUserSession(user)
activate TM
TM -> TM: Store token, userId, userType
TM --> LVM: Success
deactivate TM

LVM -> Repo: updateFcmToken(userId, token)
LVM -> Repo: updatePresence(userId, online=true)

LVM --> LF: LoginResult.Success
deactivate LVM

LF -> LF: Navigate to HomeFragment
LF --> User: Show Home Screen

note over Auth
  Firebase Authentication
  handles secure login
end note

note over TM
  DataStore stores:
  - Auth token
  - User ID
  - User type (Student/Teacher)
  - Full name
  - Avatar key
end note

@enduml
