@startuml Messaging Sequence
!theme plain

title My Nottingham - Real-time Messaging Sequence Diagram

actor "User A" as UserA
participant "ChatDetailFragment" as CDF
participant "ChatDetailViewModel" as CDVM
participant "FirebaseMessageRepository" as Repo
participant "FirebaseDatabase" as DB
participant "FCM" as FCM
actor "User B" as UserB

== Load Conversation ==
UserA -> CDF: Open chat with User B
CDF -> CDVM: loadMessages(conversationId)
activate CDVM

CDVM -> Repo: getMessagesFlow(conversationId)
activate Repo
Repo -> DB: addValueEventListener("conversations/{id}/messages")
activate DB
DB --> Repo: Initial messages snapshot
Repo --> CDVM: Flow<List<ChatMessage>>
deactivate Repo

CDVM --> CDF: Update messages LiveData
CDF -> CDF: Display messages in RecyclerView
deactivate CDVM

== Send Message ==
UserA -> CDF: Type and send message
CDF -> CDVM: sendMessage(text)
activate CDVM

CDVM -> Repo: sendMessage(conversationId, message)
activate Repo

Repo -> DB: push() new message
activate DB
DB --> Repo: MessageId
deactivate DB

Repo -> DB: update lastMessage & timestamp
Repo -> DB: increment unreadCount for User B

Repo -> FCM: sendNotification(userId=B, message)
activate FCM
FCM --> UserB: Push notification
deactivate FCM

Repo --> CDVM: Result.Success
deactivate Repo

deactivate CDVM

== Real-time Update (User B) ==
DB -> Repo: onDataChange (new message)
activate Repo
Repo --> CDVM: Emit new message via Flow
CDVM --> CDF: Update UI
deactivate Repo

note over DB
  Firebase Realtime Database
  provides real-time sync
  via ValueEventListener
end note

note over FCM
  Firebase Cloud Messaging
  delivers push notifications
  when app is in background
end note

@enduml
