这是一个非常合理的需求，可以将“过期”的订单管理和“即将来临”的订单管理区分开。

我们需要修改 `SportsBookingAdapter.kt` 来改变按钮的状态（从“不可取消”变为“删除”），同时也建议微调 `SportsMyBookingsFragment.kt` 里的弹窗提示，让体验更自然。

### 1\. 修改 `SportsBookingAdapter.kt`

这里我们需要引入 `ZoneId` 来确保时区正确，并增加判断：如果当前时间超过了“预定结束时间”（即开始时间+1小时），则将按钮变为 **"Delete"** 状态。

```kotlin
package com.nottingham.mynottingham.ui.booking

import android.graphics.Color
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Button
import android.widget.TextView
import androidx.recyclerview.widget.RecyclerView
import com.nottingham.mynottingham.R
import com.nottingham.mynottingham.data.local.database.entities.BookingEntity
import java.time.LocalDate
import java.time.LocalDateTime
import java.time.LocalTime
import java.time.ZoneId // [新增] 导入 ZoneId

class SportsBookingAdapter(
    private var bookings: List<BookingEntity>,
    private val onCancelClick: (BookingEntity) -> Unit
) : RecyclerView.Adapter<SportsBookingAdapter.BookingViewHolder>() {

    fun updateData(newBookings: List<BookingEntity>) {
        bookings = newBookings
        notifyDataSetChanged()
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): BookingViewHolder {
        val view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_sports_booking, parent, false)
        return BookingViewHolder(view)
    }

    override fun onBindViewHolder(holder: BookingViewHolder, position: Int) {
        holder.bind(bookings[position])
    }

    override fun getItemCount() = bookings.size

    inner class BookingViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {
        private val tvFacilityName: TextView = itemView.findViewById(R.id.tv_facility_name)
        private val tvDateTime: TextView = itemView.findViewById(R.id.tv_date_time)
        private val tvStatus: TextView = itemView.findViewById(R.id.tv_status)
        private val btnCancel: Button = itemView.findViewById(R.id.btn_cancel)

        fun bind(booking: BookingEntity) {
            tvFacilityName.text = booking.facilityName
            
            val timeString = String.format("%02d:00", booking.timeSlot)
            tvDateTime.text = "${booking.bookingDate} at $timeString"
            
            tvStatus.text = booking.status.uppercase()

            try {
                val bookingDate = LocalDate.parse(booking.bookingDate)
                val bookingTime = LocalTime.of(booking.timeSlot, 0)
                val bookingDateTime = LocalDateTime.of(bookingDate, bookingTime)
                
                // [关键修复] 统一使用马来西亚时区，防止时间判断出错
                val zoneId = ZoneId.of("Asia/Kuala_Lumpur")
                val now = LocalDateTime.now(zoneId)
                
                // 定义关键时间点
                // 1. 取消截止时间：开始前1小时
                val cancelDeadline = bookingDateTime.minusHours(1)
                // 2. 预定结束时间：开始后1小时（假设每场1小时）
                val endTime = bookingDateTime.plusHours(1)

                if (now.isAfter(endTime)) {
                    // --- 情况A: 预定已结束 (过期) ---
                    // 按钮变为 "Delete"，允许点击删除记录
                    btnCancel.isEnabled = true
                    btnCancel.text = "Delete"
                    btnCancel.setTextColor(Color.RED) // 或者你可以设为黑色/灰色，视设计而定
                    btnCancel.setOnClickListener {
                        onCancelClick(booking)
                    }
                } else if (now.isAfter(cancelDeadline)) {
                    // --- 情况B: 临近开始 或 正在进行中 (不可取消) ---
                    // 按钮变灰，禁用，显示提示文字 (如 Locked 或 Started)
                    btnCancel.isEnabled = false
                    btnCancel.text = "Locked" // 根据你的描述，这里不再显示 Non-cancellable，改为 Locked 或其他状态
                    btnCancel.setTextColor(Color.GRAY)
                } else {
                    // --- 情况C: 还在可取消范围内 ---
                    btnCancel.isEnabled = true
                    btnCancel.text = "Cancel"
                    btnCancel.setTextColor(Color.RED)
                    btnCancel.setOnClickListener {
                        onCancelClick(booking)
                    }
                }
            } catch (e: Exception) {
                e.printStackTrace()
                btnCancel.isEnabled = true
            }
        }
    }
}
```

### 2\. 修改 `SportsMyBookingsFragment.kt`

为了更好的用户体验，当用户点击 "Delete"（删除历史记录）时，弹出的提示框内容应该和 "Cancel"（取消未来预定）有所区别。

```kotlin
// 需要导入时间相关类
import java.time.ZoneId
import java.time.LocalDateTime
import java.time.LocalDate
import java.time.LocalTime

// ... 在 Fragment 类中 ...

    private fun showCancelConfirmationDialog(booking: com.nottingham.mynottingham.data.local.database.entities.BookingEntity) {
        // 重新计算一下时间，以决定弹窗显示 "Cancel" 还是 "Delete"
        val zoneId = ZoneId.of("Asia/Kuala_Lumpur")
        val now = LocalDateTime.now(zoneId)
        
        val bookingDate = LocalDate.parse(booking.bookingDate)
        val bookingTime = LocalTime.of(booking.timeSlot, 0)
        val bookingDateTime = LocalDateTime.of(bookingDate, bookingTime)
        val endTime = bookingDateTime.plusHours(1)

        // 判断是否是“过期删除”操作
        val isPast = now.isAfter(endTime)

        // 根据状态设置弹窗文案
        val title = if (isPast) "Delete History" else "Cancel Booking"
        val message = if (isPast) 
            "Do you want to delete this booking record?" 
        else 
            "Are you sure you want to cancel your booking for ${booking.facilityName}?"

        AlertDialog.Builder(requireContext())
            .setTitle(title)
            .setMessage(message)
            .setPositiveButton("Yes") { _, _ ->
                // 无论是取消还是删除，实际上都是从数据库移除该条目，所以调用同一个 ViewModel 方法即可
                viewModel.cancelBooking(booking)
                
                val toastMsg = if (isPast) "Record deleted" else "Booking cancelled"
                Toast.makeText(requireContext(), toastMsg, Toast.LENGTH_SHORT).show()
            }
            .setNegativeButton("No", null)
            .show()
    }
```

### 改动总结：

1.  **时间分段**：引入了 `endTime` (预定时间 + 1小时)。
2.  **状态区分**：
      * **过去 (Delete)**: 时间 \> 结束时间。按钮变为 "Delete"，**可点击**。
      * **锁定 (Locked)**: 截止时间 \< 时间 \< 结束时间。按钮变灰，**不可点击**。
      * **未来 (Cancel)**: 时间 \< 截止时间。按钮为 "Cancel"，**可点击**。
3.  **时区一致性**：使用了 `Asia/Kuala_Lumpur`，确保和之前的修复保持一致。